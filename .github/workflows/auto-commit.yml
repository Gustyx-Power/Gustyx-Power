name: Auto Racing Commit

on:
  schedule:
    - cron: "*/10 * * * *" # jalan tiap 10 menit
  workflow_dispatch:

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate racing animation with score
        run: |
          mkdir -p .cache

          # Frame index
          frame_file=".cache/frame_index"
          idx=$(( ( $(cat $frame_file 2>/dev/null || echo 0 ) + 1 ) % 10 ))
          echo $idx > $frame_file

          # Score file
          score_file=".cache/score"
          if [ ! -f "$score_file" ]; then
            echo "0 0" > $score_file  # merah biru
          fi
          read red_score blue_score < $score_file

          # Panjang track
          track="â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›"

          # Mobil 1 (merah, kiri -> kanan)
          pos1=$idx
          car1="ğŸï¸ğŸ’¨"
          line1="${track:0:pos1}${car1}${track:pos1}"
          if [ "$pos1" -eq 9 ]; then
            red_score=$((red_score+1))
          fi

          # Mobil 2 (biru, kanan -> kiri)
          pos2=$((9 - idx))
          car2="ğŸ’¨ğŸï¸"
          line2="${track:0:pos2}${car2}${track:pos2}"
          if [ "$pos2" -eq 0 ]; then
            blue_score=$((blue_score+1))
          fi

          echo "$red_score $blue_score" > $score_file

          # Finish line
          line3="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ğŸ"

          # Penonton random
          emojis=(ğŸ“£ ğŸ¿ ğŸ¥³ ğŸ‘¯ ğŸ‰ ğŸ¶ ğŸ’ƒ ğŸ•º)
          crowd=""
          for i in {1..6}; do
            crowd+="${emojis[$RANDOM % ${#emojis[@]}]} "
          done
          line4="$crowd"

          # Scoreboard
          line5="ğŸï¸ Merah: $red_score  |  ğŸ’¨ Biru: $blue_score"

          # Update README.md
          awk -v l1="$line1" -v l2="$line2" -v l3="$line3" -v l4="$line4" -v l5="$line5" '
            /<!--START_ANIMATION-->/ {print; print "```\n" l1 "\n" l2 "\n" l3 "\n" l4 "\n" l5 "\n```"; skip=1; next}
            /<!--END_ANIMATION-->/ {skip=0}
            skip!=1 {print}
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md .cache/*
          git commit -m "chore: update racing animation frame" || echo "No changes to commit"
          git push